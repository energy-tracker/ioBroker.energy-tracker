{
  "version": 3,
  "sources": ["../../src/lib/energy-tracker-api.ts"],
  "sourcesContent": ["import axios from \"axios\";\n\nexport class EnergyTrackerApi {\n  private readonly baseUrl = \"https://public-api.energy-tracker.best-ios-apps.de\";\n\n  constructor(private readonly adapter: ioBroker.Adapter) {}\n\n  async sendReading(device: ioBroker.AdapterDevice): Promise<void> {\n    const logPrefix = `[${device.sourceState}]`;\n\n    try {\n      const state = await this.adapter.getForeignStateAsync(device.sourceState);\n      if (!state || typeof state.val !== \"number\") {\n        this.adapter.log.warn(`Invalid or missing state for ${device.sourceState}`);\n        return;\n      }\n\n      const body = { value: state.val };\n\n      await axios.post(`${this.baseUrl}/v1/devices/${device.deviceId}/meter-readings`, body, {\n        headers: {\n          Authorization: `Bearer ${this.adapter.config.bearerToken}`,\n          \"Content-Type\": \"application/json\",\n        },\n        params: device.allowRounding ? { allowRounding: true } : {},\n      });\n\n      this.adapter.log.info(`${logPrefix} Reading sent: ${state.val}`);\n      await this.adapter.setState(\"info.connection\", { val: true, ack: true });\n    } catch (err) {\n      await this.adapter.setState(\"info.connection\", { val: false, ack: true });\n      this.handleError(logPrefix, err);\n    }\n  }\n\n  private handleError(logPrefix: string, err: unknown): void {\n    if (!axios.isAxiosError(err)) {\n      this.adapter.log.error(`${logPrefix} Unexpected error: ${err}`);\n      return;\n    }\n\n    const { status, data } = err.response ?? {};\n\n    if (status === undefined) {\n      this.adapter.log.error(`${logPrefix} Network error: ${err.message}`);\n      return;\n    }\n\n    switch (status) {\n      case 400:\n        this.adapter.log.warn(`${logPrefix} Bad Request: ${data?.message ?? \"Invalid input\"}`);\n        break;\n      case 401:\n        this.adapter.log.warn(`${logPrefix} Unauthorized: Check your access token`);\n        break;\n      case 403:\n        this.adapter.log.warn(`${logPrefix} Forbidden: Insufficient permissions`);\n        break;\n      case 429:\n        const retryAfter = err.response?.headers?.[\"retry-after\"];\n        const retryAfterSec = Number(retryAfter);\n\n        let msg = `${logPrefix} Too many requests: Rate limit exceeded`;\n        if (retryAfter && !isNaN(retryAfterSec)) {\n          msg += ` \u2013 Retry after ${retryAfter} seconds.`;\n        }\n\n        this.adapter.log.warn(msg);\n        break;\n      default:\n        if (status >= 500 && status <= 599) {\n          this.adapter.log.warn(\n            `${logPrefix} Server error ${status}: ${data?.message ?? \"Internal server error\"}`\n          );\n        } else {\n          this.adapter.log.warn(\n            `${logPrefix} Unexpected HTTP ${status}: ${data?.message ?? \"Unknown error\"}`\n          );\n        }\n    }\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAkB;AAEX,MAAM,iBAAiB;AAAA,EAG5B,YAA6B,SAA2B;AAA3B;AAAA,EAA4B;AAAA,EAFxC,UAAU;AAAA,EAI3B,MAAM,YAAY,QAA+C;AAC/D,UAAM,YAAY,IAAI,OAAO,WAAW;AAExC,QAAI;AACF,YAAM,QAAQ,MAAM,KAAK,QAAQ,qBAAqB,OAAO,WAAW;AACxE,UAAI,CAAC,SAAS,OAAO,MAAM,QAAQ,UAAU;AAC3C,aAAK,QAAQ,IAAI,KAAK,gCAAgC,OAAO,WAAW,EAAE;AAC1E;AAAA,MACF;AAEA,YAAM,OAAO,EAAE,OAAO,MAAM,IAAI;AAEhC,YAAM,aAAAA,QAAM,KAAK,GAAG,KAAK,OAAO,eAAe,OAAO,QAAQ,mBAAmB,MAAM;AAAA,QACrF,SAAS;AAAA,UACP,eAAe,UAAU,KAAK,QAAQ,OAAO,WAAW;AAAA,UACxD,gBAAgB;AAAA,QAClB;AAAA,QACA,QAAQ,OAAO,gBAAgB,EAAE,eAAe,KAAK,IAAI,CAAC;AAAA,MAC5D,CAAC;AAED,WAAK,QAAQ,IAAI,KAAK,GAAG,SAAS,kBAAkB,MAAM,GAAG,EAAE;AAC/D,YAAM,KAAK,QAAQ,SAAS,mBAAmB,EAAE,KAAK,MAAM,KAAK,KAAK,CAAC;AAAA,IACzE,SAAS,KAAK;AACZ,YAAM,KAAK,QAAQ,SAAS,mBAAmB,EAAE,KAAK,OAAO,KAAK,KAAK,CAAC;AACxE,WAAK,YAAY,WAAW,GAAG;AAAA,IACjC;AAAA,EACF;AAAA,EAEQ,YAAY,WAAmB,KAAoB;AAnC7D;AAoCI,QAAI,CAAC,aAAAA,QAAM,aAAa,GAAG,GAAG;AAC5B,WAAK,QAAQ,IAAI,MAAM,GAAG,SAAS,sBAAsB,GAAG,EAAE;AAC9D;AAAA,IACF;AAEA,UAAM,EAAE,QAAQ,KAAK,KAAI,SAAI,aAAJ,YAAgB,CAAC;AAE1C,QAAI,WAAW,QAAW;AACxB,WAAK,QAAQ,IAAI,MAAM,GAAG,SAAS,mBAAmB,IAAI,OAAO,EAAE;AACnE;AAAA,IACF;AAEA,YAAQ,QAAQ;AAAA,MACd,KAAK;AACH,aAAK,QAAQ,IAAI,KAAK,GAAG,SAAS,kBAAiB,kCAAM,YAAN,YAAiB,eAAe,EAAE;AACrF;AAAA,MACF,KAAK;AACH,aAAK,QAAQ,IAAI,KAAK,GAAG,SAAS,wCAAwC;AAC1E;AAAA,MACF,KAAK;AACH,aAAK,QAAQ,IAAI,KAAK,GAAG,SAAS,sCAAsC;AACxE;AAAA,MACF,KAAK;AACH,cAAM,cAAa,eAAI,aAAJ,mBAAc,YAAd,mBAAwB;AAC3C,cAAM,gBAAgB,OAAO,UAAU;AAEvC,YAAI,MAAM,GAAG,SAAS;AACtB,YAAI,cAAc,CAAC,MAAM,aAAa,GAAG;AACvC,iBAAO,uBAAkB,UAAU;AAAA,QACrC;AAEA,aAAK,QAAQ,IAAI,KAAK,GAAG;AACzB;AAAA,MACF;AACE,YAAI,UAAU,OAAO,UAAU,KAAK;AAClC,eAAK,QAAQ,IAAI;AAAA,YACf,GAAG,SAAS,iBAAiB,MAAM,MAAK,kCAAM,YAAN,YAAiB,uBAAuB;AAAA,UAClF;AAAA,QACF,OAAO;AACL,eAAK,QAAQ,IAAI;AAAA,YACf,GAAG,SAAS,oBAAoB,MAAM,MAAK,kCAAM,YAAN,YAAiB,eAAe;AAAA,UAC7E;AAAA,QACF;AAAA,IACJ;AAAA,EACF;AACF;",
  "names": ["axios"]
}
